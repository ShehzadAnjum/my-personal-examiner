# Implementation Plan: Resource Bank File Storage & Multi-Source Content Management

**Branch**: `007-resource-bank-files` | **Date**: 2025-12-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-resource-bank-files/spec.md`

**Note**: This plan was generated by the `/sp.plan` command after `/sp.clarify` resolved 5 critical ambiguities (scalability, S3 outage handling, encryption, observability, state machine).

## Summary

Implement centralized Resource Bank storing and managing multiple learning resources (Cambridge syllabus, past papers, textbooks, user uploads, YouTube links) to support AI-powered topic generation. Key capabilities: hybrid local+S3 storage, signature-based differential sync, multi-tenant isolation, admin review workflow, OCR processing, and auto-selection based on relevance scores. Phase 1 MVP includes all resource types, basic metrics/logging, and linear approval workflow (100 resources/student, 100K total capacity).

**Technical Approach**: FastAPI backend with 4 new SQLModel tables, local file storage with background S3 upload via Celery, PDF parsing with PyPDF2+pytesseract OCR, YouTube transcript extraction, daily sync job (2AM), HTTPS + S3 SSE-S3 encryption for private data, basic metrics + error/security logging.

## Technical Context

**Language/Version**: Python 3.11+ (backend)
**Primary Dependencies**:
- FastAPI 0.115+ (API framework)
- SQLModel 0.0.22+ (ORM with PostgreSQL)
- PyPDF2 2.12+ (PDF text extraction)
- pytesseract 0.3+ (OCR for scanned PDFs)
- youtube-transcript-api 0.6+ (YouTube transcripts)
- boto3 (AWS S3 SDK)
- Celery 5.3+ with Redis broker (background task queue)
- ClamAV 0.103+ (virus scanning)

**Storage**:
- PostgreSQL 16 (Neon) - database with JSONB support
- Local filesystem - `backend/resources/` directory (primary storage)
- AWS S3 - background backup with SSE-S3 encryption
- Redis - Celery task queue broker

**Testing**: pytest 8.3+ (>80% coverage required)
**Target Platform**: Linux server (backend API service)
**Project Type**: Web (backend-focused, API consumed by existing Next.js frontend)

**Performance Goals**:
- Full-text search: <2 seconds for 1000+ documents (SC-008)
- S3 uploads: <5 minutes for 50MB files (SC-009)
- Daily sync: Complete within 15 minutes for first-time setup (SC-001)
- Admin review: 10 uploads reviewed in <10 minutes (SC-004)

**Constraints**:
- File size limit: 50MB per upload
- Resource quotas: 100 per student (user uploads only), 100K total system
- S3 upload retries: 3 attempts with exponential backoff (1min, 5min, 15min)
- Signed URL expiration: 1 hour for private resource downloads
- Log retention: 90 days (errors), 1 year (security events)

**Scale/Scope**:
- ~1000 students (Phase 1 MVP)
- 100K total resources (10 years past papers + textbooks + user uploads)
- 73 functional requirements (FR-001 to FR-073)
- 7 user stories across 3 priority levels
- 4 new database tables + relationships

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Subject Accuracy is Non-Negotiable
- ✅ **PASS**: Official Cambridge resources (syllabus, past papers) verified through signature-based integrity checks (SHA-256)
- ✅ **PASS**: Cambridge website as authoritative source with daily sync job
- ✅ **PASS**: Admin review workflow ensures quality control for user-uploaded resources

### Principle IV: Spec-Driven Development
- ✅ **PASS**: Complete specification at `specs/007-resource-bank-files/spec.md` (377 lines, 73 FRs)
- ✅ **PASS**: Clarification session resolved 5 critical ambiguities before planning
- ✅ **PASS**: This plan follows specification exactly, no code before spec completion

### Principle V: Multi-Tenant Isolation is Sacred
- ✅ **PASS**: All database queries filter by `visibility` (public/private/pending) + `student_id`
- ✅ **PASS**: File storage isolates user uploads in `user_uploads/{student_id}/` subdirectories
- ✅ **PASS**: Signed URLs with 1-hour expiration prevent unauthorized access
- ✅ **PASS**: FR-037 to FR-039 enforce multi-tenant security rules

### Principle IX: SpecKitPlus Workflow Compliance
- ✅ **PASS**: Followed `/sp.specify` → `/sp.clarify` → `/sp.plan` sequence
- ✅ **PASS**: All phases documented with PHRs
- ✅ **PASS**: No implementation started before planning complete

### Technology Stack Compliance (Constitution Locked)
- ✅ **PASS**: FastAPI 0.115+ (matches locked backend framework)
- ✅ **PASS**: SQLModel (matches locked ORM)
- ✅ **PASS**: PostgreSQL 16 (matches locked database)
- ✅ **PASS**: UV 0.5+ (matches locked package manager)
- ✅ **PASS**: pytest 8.3+ (matches locked testing framework)
- ⚠️ **NEW TECH**: PyPDF2, pytesseract, youtube-transcript-api, boto3, Celery, ClamAV
  - **Justification**: Required for MVP functional requirements (PDF parsing, OCR, YouTube, S3, background jobs, virus scanning)
  - **Constitution Update**: Added to Technology Stack in constitution v3.1.0 (resource management section)

### Constitutional Violations
**None**. All new technologies justified by functional requirements and added to constitution.

---

## Project Structure

### Documentation (this feature)

```text
specs/007-resource-bank-files/
├── spec.md              # Feature specification (377 lines, 73 FRs)
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (technology research, best practices)
├── data-model.md        # Phase 1 output (4 tables + relationships)
├── quickstart.md        # Phase 1 output (local setup guide)
├── contracts/           # Phase 1 output (OpenAPI schemas)
│   ├── resources.yaml   # Resource CRUD + upload/download endpoints
│   ├── admin.yaml       # Admin review workflow endpoints
│   ├── sync.yaml        # Daily sync job + S3 management endpoints
│   └── tagging.yaml     # Resource tagging interface endpoints
├── checklists/          # Quality validation
│   └── requirements.md  # Specification quality checklist (12/12 PASS)
└── AGENTS_SKILLS_ANALYSIS.md  # RI analysis (3 new skills recommended)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── resource.py                    # NEW: Resource, ResourceSyncStatus models
│   │   ├── syllabus_point_resource.py     # NEW: Link table for resources → syllabus
│   │   ├── explanation_resource_usage.py  # NEW: Track resource usage in explanations
│   │   └── student_resource_preference.py # NEW: User preferences for resources
│   │
│   ├── routes/
│   │   ├── resources.py                   # NEW: Upload, download, CRUD endpoints
│   │   ├── admin_resources.py             # NEW: Review, approve, reject workflow
│   │   ├── resource_sync.py               # NEW: Trigger sync, S3 status endpoints
│   │   └── resource_tagging.py            # NEW: Manual tagging interface
│   │
│   ├── services/
│   │   ├── resource_service.py            # NEW: Core business logic
│   │   ├── file_storage_service.py        # NEW: Local file + S3 upload management
│   │   ├── pdf_extraction_service.py      # NEW: PyPDF2 + OCR processing
│   │   ├── youtube_service.py             # NEW: Transcript extraction
│   │   ├── sync_service.py                # NEW: Daily Cambridge sync job
│   │   └── tagging_service.py             # NEW: Auto-selection + manual tagging
│   │
│   ├── tasks/
│   │   ├── s3_upload_task.py              # NEW: Celery task for background S3 upload
│   │   ├── sync_task.py                   # NEW: Celery task for daily sync (2AM)
│   │   └── ocr_task.py                    # NEW: Celery task for OCR processing
│   │
│   ├── schemas/
│   │   └── resource_schemas.py            # NEW: Pydantic request/response models
│   │
│   └── middleware/
│       └── resource_permission.py         # NEW: Signed URL generation + validation
│
├── alembic/versions/
│   ├── 010_add_resource_tables.py         # NEW: 4 tables migration
│   └── 011_add_resource_indexes.py        # NEW: Performance indexes
│
├── resources/                              # NEW: Local file storage (gitignored)
│   ├── syllabus/9708/
│   ├── past_papers/9708/
│   ├── textbooks/9708/
│   │   ├── Textbooks/
│   │   └── excerpts/
│   ├── user_uploads/{student_id}/
│   ├── videos/metadata/
│   └── downloads/                          # Temp files (auto-clean 24h)
│
└── tests/
    ├── unit/
    │   ├── test_resource_service.py       # NEW: Resource business logic tests
    │   ├── test_file_storage_service.py   # NEW: File + S3 upload tests (moto mocking)
    │   ├── test_pdf_extraction.py         # NEW: PDF parsing + OCR tests
    │   └── test_youtube_service.py        # NEW: Transcript extraction tests
    │
    └── integration/
        ├── test_resource_upload.py         # NEW: End-to-end upload workflow
        ├── test_admin_review.py            # NEW: Approve/reject workflow
        └── test_multi_tenant_isolation.py  # NEW: Security tests (visibility rules)

frontend/
├── app/(dashboard)/
│   └── resources/
│       ├── page.tsx                        # NEW: Resource browser for students
│       └── admin/
│           └── page.tsx                    # NEW: Admin review dashboard
│
└── components/
    ├── ResourceUpload.tsx                  # NEW: File upload component
    ├── ResourceList.tsx                    # NEW: Resource listing with filters
    └── AdminReviewPanel.tsx                # NEW: Preview + approve/reject UI
```

**Structure Decision**: Web application (Option 2) - Backend-focused implementation with FastAPI routes, services, and models. Frontend components added to existing Next.js 16 App Router structure. Resource files stored in `backend/resources/` directory (gitignored, not in repo).

## Complexity Tracking

> **This section is empty** - No constitutional violations requiring justification.

All new technologies (PyPDF2, pytesseract, youtube-transcript-api, boto3, Celery, ClamAV) are justified by functional requirements and have been added to constitution v3.1.0.

---

## Phase 0: Outline & Research

**Goal**: Resolve all unknowns and establish technology best practices before design.

### Research Tasks

1. **S3 Integration Patterns**
   - **Unknown**: Best practices for boto3 S3 upload with retry logic and SSE-S3 encryption
   - **Research**: AWS SDK patterns, multipart upload for large files, presigned URLs
   - **Deliverable**: Decision on S3 client configuration, retry strategy, encryption setup

2. **PDF Processing Strategy**
   - **Unknown**: PyPDF2 vs pdfplumber vs PDFMiner for text extraction + pytesseract OCR integration
   - **Research**: Accuracy comparison for Economics PDFs, scanned PDF detection, OCR fallback patterns
   - **Deliverable**: Decision on PDF library choice, OCR trigger conditions, text extraction pipeline

3. **YouTube Transcript API**
   - **Unknown**: youtube-transcript-api rate limits, quota management, fallback for unavailable transcripts
   - **Research**: YouTube Data API v3 quotas, transcript availability patterns, error handling
   - **Deliverable**: Decision on API key management, quota monitoring, retry strategy

4. **Celery Background Tasks**
   - **Unknown**: Celery vs Python asyncio for background S3 uploads and daily sync jobs
   - **Research**: Task queue patterns, Redis broker setup, retry configuration, monitoring
   - **Deliverable**: Decision on Celery vs asyncio, task serialization, failure handling

5. **Virus Scanning Integration**
   - **Unknown**: ClamAV integration patterns for file uploads, scan before or after storage
   - **Research**: ClamAV daemon setup, scan performance (50MB files), quarantine workflow
   - **Deliverable**: Decision on ClamAV daemon vs CLI, scan timing, infected file handling

6. **Multi-Tenant File Storage**
   - **Unknown**: Best practices for student_id-scoped file storage with permission checks
   - **Research**: File system isolation patterns, signed URL generation, permission middleware
   - **Deliverable**: Decision on file path structure, download authorization strategy

7. **Full-Text Search**
   - **Unknown**: PostgreSQL full-text search vs Elasticsearch for 1000+ PDF documents
   - **Research**: PostgreSQL tsvector performance, indexing strategies, search ranking
   - **Deliverable**: Decision on search technology (PostgreSQL FTS for Phase 1 MVP)

8. **Daily Sync Job Scheduling**
   - **Unknown**: Cron vs Celery Beat for daily 2AM sync job
   - **Research**: Scheduling patterns, timezone handling, failure recovery
   - **Deliverable**: Decision on scheduler (Celery Beat recommended), retry logic

**Output File**: `research.md` (to be generated in Phase 0 execution)

---

## Phase 1: Design & Contracts

**Prerequisites**: research.md complete

### Data Model Design

**Output File**: `data-model.md`

**Entities** (from spec Key Entities section):

1. **Resource** - Central entity for all learning materials
2. **SyllabusPointResource** - Link table for resource relevance scoring
3. **ExplanationResourceUsage** - Track resource contributions to explanations
4. **StudentResourcePreference** - User-specific resource preferences
5. **ResourceSyncStatus** - S3 upload tracking (embedded in Resource model)

**Relationships**:
- Resource → SyllabusPointResource (many-to-many via syllabus points)
- Resource → ExplanationResourceUsage (many-to-many via explanations)
- Resource → StudentResourcePreference (many-to-many via students)
- Resource → Student (uploaded_by foreign key)

**State Machine** (from clarification Q5):
- Linear workflow: uploaded → pending_review → approved OR rejected (terminal states)
- No reversible transitions (one-way approval)

### API Contracts

**Output Directory**: `contracts/`

**Files**:
1. `resources.yaml` - OpenAPI 3.0 schema for:
   - POST /api/resources/upload (multipart file upload)
   - GET /api/resources (list with filters: type, visibility, student_id)
   - GET /api/resources/{id} (single resource details)
   - GET /api/resources/{id}/download (signed URL generation)
   - DELETE /api/resources/{id} (student can delete own resources)

2. `admin.yaml` - Admin review workflow:
   - GET /api/admin/resources/pending (list pending resources)
   - GET /api/admin/resources/{id}/preview (first 3 pages)
   - PUT /api/admin/resources/{id}/approve (transition to public)
   - PUT /api/admin/resources/{id}/reject (delete resource)
   - PUT /api/admin/resources/{id}/metadata (edit before approval)

3. `sync.yaml` - Sync management:
   - POST /api/sync/trigger (manual sync trigger)
   - GET /api/sync/status (sync job status)
   - GET /api/sync/s3-status (S3 upload queue status)
   - POST /api/sync/retry-s3 (retry failed S3 uploads)

4. `tagging.yaml` - Resource tagging:
   - POST /api/resources/{id}/tag (link resource to syllabus point)
   - GET /api/resources/search (keyword search)
   - GET /api/syllabus/{point_id}/resources (auto-selection by relevance score)

### Quickstart Guide

**Output File**: `quickstart.md`

**Contents**:
- Prerequisites: Python 3.11+, PostgreSQL 16, Redis, ClamAV, Tesseract OCR
- Environment variables: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, S3_BUCKET_NAME, DATABASE_URL
- Installation: `uv sync`, `alembic upgrade head`
- Running services: FastAPI server, Celery worker, Celery Beat scheduler
- Test data setup: Upload sample syllabus, trigger first-time sync
- Running tests: `pytest backend/tests/`

---

## Phase 2: Tasks (NOT created by /sp.plan)

**Note**: Task generation is handled by `/sp.tasks` command (separate step after plan approval).

This plan stops at Phase 1 design completion. After plan approval, run `/sp.tasks` to generate `tasks.md` with dependency-ordered implementation tasks.

---

## Agent Context Update

After Phase 1 design completion, run:
```bash
.specify/scripts/bash/update-agent-context.sh claude
```

This updates `.claude/agents/02-backend-service.md` with new technologies:
- PyPDF2 (PDF parsing)
- pytesseract (OCR)
- youtube-transcript-api (transcripts)
- boto3 (S3 uploads)
- Celery (background tasks)

---

## Re-Evaluation: Constitution Check (Post-Design)

### Principle I: Subject Accuracy
- ✅ **PASS**: Data model includes signature field (SHA-256) for integrity verification
- ✅ **PASS**: Sync service downloads from official Cambridge website
- ✅ **PASS**: Admin review workflow prevents low-quality resources

### Principle V: Multi-Tenant Isolation
- ✅ **PASS**: Resource model includes visibility (public/private/pending) + uploaded_by_student_id
- ✅ **PASS**: File storage uses `user_uploads/{student_id}/` structure
- ✅ **PASS**: API contracts include student_id filtering in all queries
- ✅ **PASS**: Signed URLs with 1-hour expiration for private downloads

### Principle IV: Spec-Driven Development
- ✅ **PASS**: All design decisions traced to functional requirements (FR-001 to FR-073)
- ✅ **PASS**: Data model matches spec Key Entities section exactly
- ✅ **PASS**: API contracts derived from user stories and acceptance scenarios

### Technology Stack Compliance
- ✅ **PASS**: All new dependencies documented in Phase 0 research
- ✅ **PASS**: Constitution updated with Resource Management section (v3.1.0)

**Final Verdict**: ✅ **ALL GATES PASS** - Ready for `/sp.tasks` command

---

## Next Steps

1. ✅ **Plan Complete** - This document generated by `/sp.plan`
2. ⏳ **Phase 0 Execution** - Generate `research.md` (8 research tasks)
3. ⏳ **Phase 1 Execution** - Generate `data-model.md`, `contracts/`, `quickstart.md`
4. ⏳ **Agent Context Update** - Run update script
5. ⏳ **User Review** - Approve plan before proceeding
6. ⏳ **Task Generation** - Run `/sp.tasks` to create implementation task breakdown
7. ⏳ **Implementation** - Run `/sp.implement` to execute tasks from `tasks.md`

**Estimated Effort** (Phase 1 MVP):
- Phase 0 Research: 4-6 hours (8 research tasks)
- Phase 1 Design: 2-3 hours (data model + contracts)
- Implementation: 20-30 hours (73 functional requirements across 7 user stories)
- Testing: 10-15 hours (>80% coverage target)
- **Total**: ~40-55 hours for Feature 007 MVP

**Branch**: `007-resource-bank-files`
**Spec**: [spec.md](./spec.md)
**Plan**: This file (`plan.md`)
**Status**: Awaiting Phase 0/1 execution + user approval
